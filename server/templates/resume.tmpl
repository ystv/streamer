{{define "content"}}
    <div class="tabs is-toggle is-toggle-rounded">
        <ul>
            <li>
                <a href="/">
                    <span>Home</span>
                </a>
            </li>
            <li class="is-active">
                <a href="/resume">
                    <span>Resume</span>
                </a>
            </li>
            <li>
                <a href="/list">
                    <span>List</span>
                </a>
            </li>
            <li>
                <a href="/save">
                    <span>Save</span>
                </a>
            </li>
            <li>
                <a href="/recall">
                    <span>Recall</span>
                </a>
            </li>
        </ul>
    </div>
    <div class="card" id="enter">
        <div class="card-content">
            <p class="title">Resume a stream</p><br>
            <form id="resume">
                <label for="unique">Enter the code you were given after starting the stream in the box below</label><br>
                <input class="input" name="unique" id="unique" placeholder="ab12cd34ef"><br>
                <p id="error" style="color: red"></p><br>
                <input class="button" id="submit_unique" type="button" value="Submit">
            </form>
        </div>
    </div>
    <div class="card" id="resumed" hidden>
        <div class="card-content">
            <p class="title">STREAMING!</p><br>
            <p>The stream has been forwarded, the unique code of this forward is below</p><br>
            <p id="unique_code" class="subtitle"></p><br>
            <table class="table table-bordered" id="tableStatus"></table>
            <br>
            <p>This window can be closed as long as you have the code to stop the stream<br>
                If you want to return later, then you will need to go to <a
                        href="https://streamer.dev.ystv.co.uk/resume"
                        target="_blank">https://streamer.dev.ystv.co.uk/resume</a><br><br><br>
                You can stop the stream by pressing the checkbox and then the button (prevent accidental stops)</p>
            <br><br><br>
            <label for="stop_checkbox">Enable the stop button </label>
            <input name="stop_checkbox" id="stop_checkbox" type="checkbox"><br>
            <input name="stop_button" id="stop_button" type="button" class="button" value="|> STOP <|"
                   style="visibility: hidden"
                   disabled hidden>
        </div>
    </div>
    <div class="card" id="stopped_window" hidden>
        <div class="card-content">
            <p class="title">STOPPED!</p>
            <p>The forwarding has been stopped successfully<br>
                You can close this window now</p>
        </div>
    </div>
    <script>
        document.getElementById('stop_checkbox').onchange = function () {
            document.getElementById('stop_button').disabled = !this.checked;
            document.getElementById('stop_button').hidden = !this.checked;
            if (this.checked) {
                document.getElementById('stop_button').style.visibility = "visible";
            } else {
                document.getElementById('stop_button').style.visibility = "hidden";
            }
        };

        let unique;
        let statusInterval;

        let error = $('#error');

        $(document).ready(function () {
            $('#submit_unique').click(function () {
                error.html("")
                if ($('#unique').val().length === 0) {
                    error.html("The code field cannot be empty");
                    return;
                }
                $.ajax({
                    url: 'resume',
                    type: 'post',
                    dataType: 'text',
                    contentType: 'application/x-www-form-urlencoded',
                    data: $('#resume').serialize(),
                    success: function (data) {
                        const jsonData1 = JSON.parse(data);
                        if (jsonData1.error !== "") {
                            error.html("Unique code not accepted");
                            console.log(jsonData1.error);
                            return;
                        }

                        if (jsonData1.response !== "ACCEPTED!") {
                            error.html("Unique code not accepted");
                            console.log(jsonData1.response);
                            return;
                        }
                        document.getElementById('enter').hidden = true;
                        document.getElementById('enter').style.visibility = "hidden";
                        document.getElementById('resumed').hidden = false;
                        document.getElementById('resumed').style.visibility = "visible";
                        let uniqueField = $('#unique');
                        unique = uniqueField.val();
                        $('#unique_code').html(uniqueField.val());
                        let tableStatus = $('#tableStatus');
                        if (jsonData1.recording) {
                            tableStatus.append('<tr><td><p class="subtitle">Recording status</p><p id="recording_status"></p><br></td></tr>');
                        }
                        if (jsonData1.website) {
                            tableStatus.append('<tr><td><p class="subtitle">Website status</p><p id="website_status"></p><br></td></tr>');
                        }
                        let streams = jsonData1.streams
                        for (let i = 1; i <= streams; i++) {
                            tableStatus.append('<tr><td><p class="subtitle">Stream ' + i + ' status</p><p id="' + i + '_status"></p><br></td></tr>');
                        }
                        statusInterval = setInterval(function () {
                            $.ajax({
                                url: 'status',
                                type: 'post',
                                dataType: 'text',
                                contentType: 'application/x-www-form-urlencoded',
                                data: ({"unique_code": unique}),
                                success: function (data) {
                                    const jsonData2 = JSON.parse(data);
                                    if (jsonData2.error !== "") {
                                        document.getElementById("statusError").innerHTML = jsonData2.error
                                    } else {
                                        for (let j = 0; j < jsonData2.status.length; j++) {
                                            let status1 = jsonData2.status[j]
                                            if (status1.error.length > 0) {
                                                document.getElementById(status1.name + "_status").innerHTML = status1.error;
                                            } else {
                                                document.getElementById(status1.name + "_status").innerHTML = status1.response;
                                            }
                                        }
                                    }
                                },
                            })
                        }, 5000);
                    },
                })
            });

            let stopButton = $('#stop_button');

            stopButton.click(function () {
                stopButton.disabled = true;
                console.log("Stop pressed")
                $.ajax({
                    url: 'stop',
                    type: 'post',
                    dataType: 'text',
                    contentType: 'application/x-www-form-urlencoded',
                    data: ({"unique_code": unique}),
                    success: function (data) {
                        if (data === "STOPPED!") {
                            document.getElementById('resumed').hidden = true;
                            document.getElementById('resumed').style.visibility = "hidden";
                            document.getElementById('stopped_window').hidden = false;
                            document.getElementById('stopped_window').style.visibility = "visible";
                            unique = "";
                            clearInterval(statusInterval);
                        }
                    },
                })
                stopButton.disabled = false;
            })
        });
    </script>
{{end}}